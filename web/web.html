<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Uploader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom font for a clean, modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        /* Style the main container with a darker background */
        .container {
            background-color: #2a2a44;
        }
        /* Add hover effects and shadows to the button for a more interactive feel */
        .btn {
            background-color: #6a0dad;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background-color: #8c2bd9;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(106, 13, 173, 0.4);
        }
        /* Style the file input label with a dashed border */
        .file-input-label {
            border: 2px dashed #6a0dad;
            transition: border-color 0.3s ease;
        }
        /* Add hover effect to the file input label to indicate it's interactive */
        .file-input-label:hover {
            border-color: #8c2bd9;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-8 rounded-2xl shadow-lg w-full max-w-xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-purple-400">Upload to S3</h1>

        <!-- Status message area to provide user feedback -->
        <div id="status-message" class="hidden mb-4 p-3 rounded-lg text-center" role="alert"></div>

        <div class="flex flex-col items-center space-y-4">
            <!-- The label acts as a clickable drop zone for the file input -->
            <label for="file-input" class="file-input-label flex flex-col items-center justify-center w-full h-48 rounded-2xl cursor-pointer p-4 text-center text-gray-400">
                <!-- SVG icon for a visual cue -->
                <svg class="w-12 h-12 text-purple-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path>
                    <path fill-rule="evenodd" d="M18 8a2 2 0 01-2 2h-1.39l-1.35-2.7a2 2 0 00-3.64 0L7.39 10H6a2 2 0 01-2-2V4a2 2 0 012-2h4a2 2 0 012 2v2a2 2 0 012 2v1.39l1.35 2.7a2 2 0 003.64 0l1.35-2.7H18a2 2 0 012 2v2a2 2 0 01-2 2zM5 10a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"></path>
                </svg>
                <p class="mt-2 text-sm text-gray-400"><span class="font-semibold text-purple-300">Click to upload</span> or drag and drop</p>
                <p class="text-xs text-gray-500">Any file up to 10MB</p>
                <!-- Display selected file name here -->
                <p id="file-name" class="mt-2 font-medium text-purple-300 hidden"></p>
            </label>
            <!-- The actual file input, hidden from view -->
            <input type="file" id="file-input" class="hidden" />

            <button id="upload-btn" class="btn w-full px-6 py-3 rounded-xl font-bold text-lg text-white shadow-lg">
                Upload File
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('file-input');
            const uploadBtn = document.getElementById('upload-btn');
            const statusMessage = document.getElementById('status-message');
            const fileNameDisplay = document.getElementById('file-name');

            let selectedFile = null;

            // Function to display a status message to the user
            function showStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = 'block mb-4 p-3 rounded-lg text-center';
                if (type === 'success') {
                    statusMessage.classList.add('bg-green-600', 'text-white');
                } else if (type === 'error') {
                    statusMessage.classList.add('bg-red-600', 'text-white');
                } else {
                    statusMessage.classList.add('bg-gray-700', 'text-gray-200');
                }
                statusMessage.classList.remove('hidden');
            }

            // Handle file selection via button click
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    selectedFile = file;
                    fileNameDisplay.textContent = file.name;
                    fileNameDisplay.classList.remove('hidden');
                    showStatus(`Selected file: ${file.name}`, 'info');
                }
            });

            // Handle drag and drop functionality
            const fileInputLabel = document.querySelector('.file-input-label');
            fileInputLabel.addEventListener('dragover', (event) => {
                event.preventDefault();
                fileInputLabel.classList.add('border-purple-300');
            });
            fileInputLabel.addEventListener('dragleave', (event) => {
                fileInputLabel.classList.remove('border-purple-300');
            });
            fileInputLabel.addEventListener('drop', (event) => {
                event.preventDefault();
                fileInputLabel.classList.remove('border-purple-300');
                const file = event.dataTransfer.files[0];
                if (file) {
                    selectedFile = file;
                    fileNameDisplay.textContent = file.name;
                    fileNameDisplay.classList.remove('hidden');
                    showStatus(`Selected file: ${file.name}`, 'info');
                }
            });

            // Handle upload button click
            uploadBtn.addEventListener('click', async () => {
                if (!selectedFile) {
                    showStatus('Please select a file first.', 'error');
                    return;
                }

                showStatus('Uploading...', 'info');

                try {
                    // Step 1: Request pre-signed URL from Lambda
                    const apiUrl = 'https://nswya19290.execute-api.us-east-1.amazonaws.com/prod/upload/' + encodeURIComponent(selectedFile.name);
                    const urlResponse = await fetch(apiUrl, { method: 'GET' });
                    if (!urlResponse.ok) throw new Error(`Failed to get pre-signed URL: ${urlResponse.status}`);
                    const { uploadUrl } = await urlResponse.json();  // Lambda returns the signed S3 URL

                    // Step 2: Upload file using the pre-signed URL as-is (no encoding, no modifications)
                    const s3Response = await fetch(uploadUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/octet-stream'
                        },
                        body: selectedFile,
                    });

                    if (s3Response.ok) {
                        showStatus('Upload successful! ðŸŽ‰', 'success');
                        console.log('File uploaded successfully to S3');
                    } else {
                        const errorText = await s3Response.text();
                        showStatus(`Upload failed. Status: ${s3Response.status}. See console for details.`, 'error');
                        console.error('S3 Upload Error:', errorText);
                        console.error('S3 Response Status:', s3Response.status);
                        console.error('S3 Response Headers:', s3Response.headers);
                    }

                } catch (error) {
                    showStatus(`Upload failed. See console for details.`, 'error');
                    console.error('An error occurred during the upload process:', error);
                }
            });
        });
    </script>

</body>
</html>
